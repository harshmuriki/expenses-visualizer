#!/usr/bin/env node

/**
 * Fix Color References Script
 * 
 * This script fixes the color references that were incorrectly generated by the migration script.
 * It converts `colors.primary.500` format to proper Tailwind classes.
 */

const fs = require('fs');
const path = require('path');

// Color mappings from colors.xxx format to Tailwind classes
const colorMappings = {
    // Primary colors
    'colors.primary.50': 'primary-50',
    'colors.primary.100': 'primary-100',
    'colors.primary.200': 'primary-200',
    'colors.primary.300': 'primary-300',
    'colors.primary.400': 'primary-400',
    'colors.primary.500': 'primary-500',
    'colors.primary.600': 'primary-600',
    'colors.primary.700': 'primary-700',
    'colors.primary.800': 'primary-800',
    'colors.primary.900': 'primary-900',

    // Secondary colors
    'colors.secondary.50': 'secondary-50',
    'colors.secondary.100': 'secondary-100',
    'colors.secondary.200': 'secondary-200',
    'colors.secondary.300': 'secondary-300',
    'colors.secondary.400': 'secondary-400',
    'colors.secondary.500': 'secondary-500',
    'colors.secondary.600': 'secondary-600',
    'colors.secondary.700': 'secondary-700',
    'colors.secondary.800': 'secondary-800',
    'colors.secondary.900': 'secondary-900',

    // Accent colors
    'colors.accent.50': 'accent-50',
    'colors.accent.100': 'accent-100',
    'colors.accent.200': 'accent-200',
    'colors.accent.300': 'accent-300',
    'colors.accent.400': 'accent-400',
    'colors.accent.500': 'accent-500',
    'colors.accent.600': 'accent-600',
    'colors.accent.700': 'accent-700',
    'colors.accent.800': 'accent-800',
    'colors.accent.900': 'accent-900',

    // Background colors
    'colors.background.primary': 'background-primary',
    'colors.background.secondary': 'background-secondary',
    'colors.background.tertiary': 'background-tertiary',
    'colors.background.glass': 'background-glass',
    'colors.background.card': 'background-card',

    // Text colors
    'colors.text.primary': 'text-primary',
    'colors.text.secondary': 'text-secondary',
    'colors.text.tertiary': 'text-tertiary',
    'colors.text.inverse': 'text-inverse',

    // Border colors
    'colors.border.primary': 'border-primary',
    'colors.border.secondary': 'border-secondary',
    'colors.border.focus': 'border-focus',
    'colors.border.glass': 'border-glass',

    // Semantic colors
    'colors.success': 'success',
    'colors.warning': 'warning',
    'colors.error': 'error',
    'colors.info': 'info',
};

// Function to fix color references in a file
function fixColorReferences(filePath) {
    try {
        let content = fs.readFileSync(filePath, 'utf8');
        let changes = 0;

        // Replace colors.xxx references
        Object.entries(colorMappings).forEach(([oldRef, newClass]) => {
            // Handle different contexts where colors.xxx might appear
            const patterns = [
                // In className attributes
                new RegExp(`\\[${oldRef.replace(/\./g, '\\.')}\\]`, 'g'),
                // In style attributes
                new RegExp(`\\{${oldRef.replace(/\./g, '\\.')}\\}`, 'g'),
                // In template literals
                new RegExp(`\\$\\{${oldRef.replace(/\./g, '\\.')}\\}`, 'g'),
                // Direct references
                new RegExp(oldRef.replace(/\./g, '\\.'), 'g'),
            ];

            patterns.forEach(pattern => {
                const matches = content.match(pattern);
                if (matches) {
                    content = content.replace(pattern, newClass);
                    changes += matches.length;
                    console.log(`  ‚úì Replaced ${matches.length} instances of ${oldRef} with ${newClass}`);
                }
            });
        });

        if (changes > 0) {
            fs.writeFileSync(filePath, content);
            console.log(`  üìù Updated ${filePath} with ${changes} changes`);
        } else {
            console.log(`  ‚è≠Ô∏è  No changes needed for ${filePath}`);
        }

        return changes;
    } catch (error) {
        console.error(`  ‚ùå Error processing ${filePath}:`, error.message);
        return 0;
    }
}

// Function to scan directory for files
function scanDirectory(dir, extensions = ['.tsx', '.ts', '.jsx', '.js']) {
    const files = [];

    function scan(currentDir) {
        const items = fs.readdirSync(currentDir);

        items.forEach(item => {
            const fullPath = path.join(currentDir, item);
            const stat = fs.statSync(fullPath);

            if (stat.isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
                scan(fullPath);
            } else if (stat.isFile() && extensions.some(ext => item.endsWith(ext))) {
                files.push(fullPath);
            }
        });
    }

    scan(dir);
    return files;
}

// Main fix function
function fixColorReferences() {
    console.log('üîß Fixing Color References...\n');

    const componentsDir = path.join(__dirname, '../components');
    const appDir = path.join(__dirname, '../app');

    const files = [
        ...scanDirectory(componentsDir),
        ...scanDirectory(appDir),
    ];

    console.log(`üìÅ Found ${files.length} files to process\n`);

    let totalChanges = 0;
    let processedFiles = 0;

    files.forEach(file => {
        console.log(`üîç Processing ${path.relative(process.cwd(), file)}...`);
        const changes = fixColorReferences(file);
        totalChanges += changes;
        if (changes > 0) processedFiles++;
        console.log('');
    });

    console.log('üìä Fix Summary:');
    console.log(`  üìÅ Files processed: ${files.length}`);
    console.log(`  ‚úèÔ∏è  Files modified: ${processedFiles}`);
    console.log(`  üîÑ Total changes: ${totalChanges}`);

    if (totalChanges > 0) {
        console.log('\n‚úÖ Color references fixed! Theme switching should now work properly.');
        console.log('\nüìù Next steps:');
        console.log('  1. Test the theme switcher on your homepage');
        console.log('  2. Verify that colors change when switching themes');
        console.log('  3. Check that all components use the new color system');
    } else {
        console.log('\n‚ú® No color reference issues found! Your project is already using the correct format.');
    }
}

// Run fix if called directly
if (require.main === module) {
    fixColorReferences();
}

module.exports = { fixColorReferences, colorMappings };
